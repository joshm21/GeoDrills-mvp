<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drill | GeoDrills</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Georgian:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --geo-red: #A70007;
            --geo-dark: #2c3e50;
            --bg: #f8f5f0;
            --card-white: #ffffff;
        }

        body {
            font-family: 'Noto Sans Georgian', -apple-system, sans-serif;
            background-color: var(--bg); margin: 0; color: var(--geo-dark);
        }

        /* --- NAVIGATION --- */
        .site-header {
            background: var(--geo-dark);
            color: white;
            position: sticky; top: 0; z-index: 1000;
            border-bottom: 4px solid var(--geo-red);
        }

        .nav-container {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
        }

        .brand { font-weight: bold; font-size: 1.2rem; text-decoration: none; color: white; }

        /* Hamburger Icon */
        .menu-toggle {
            display: none;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
            background: none; border: none; padding: 5px;
        }
        .menu-toggle span {
            display: block; width: 25px; height: 3px;
            background: white; border-radius: 2px;
        }

        .nav-links { display: flex; gap: 10px; }
        .nav-link {
            color: #ecf0f1; text-decoration: none; padding: 8px 15px;
            border-radius: 6px; font-size: 14px; transition: 0.2s;
        }
        .nav-link.active { background: var(--geo-red); color: white; }

        /* --- MOBILE NAV (Under 768px) --- */
        @media (max-width: 768px) {
            .menu-toggle { display: flex; }

            .nav-links {
                display: none; /* Hidden by default */
                flex-direction: column;
                position: absolute;
                top: 60px; left: 0; width: 100%;
                background: var(--geo-dark);
                padding: 10px 0;
                border-bottom: 4px solid var(--geo-red);
            }

            .nav-links.is-open { display: flex; }
            .nav-link { width: 100%; text-align: center; border-radius: 0; padding: 15px 0; }
        }

        /* --- LAYOUT --- */
        .container { max-width: 600px; margin: 0 auto; padding: 15px; }
        .card {
            background: var(--card-white); border-radius: 12px;
            padding: 20px; margin-bottom: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        
/* 1. GLOBAL DEFAULTS & ANTI-FLICKER */
[v-cloak] { display: none !important; }

* { 
    box-sizing: border-box; /* Fixes input and button overflow */
}

#app {
    width: 100%;
    max-width: 650px;
    min-height: calc(100vh - 150px);
    margin: 0 auto;
    display: flex;
    flex-direction: column;
}

/* 2. LAYOUT SECTIONS */
.content-section {
    display: flex;
    flex-direction: column;
    flex: 1;
    padding: 1rem;
}

.prompt-area {
    flex: 0 0 auto;
    min-height: 120px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
    border-bottom: 2px solid #eee;
    margin-bottom: 20px;
    padding-bottom: 15px;
}

.media-placeholder {
    height: 70px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.question-img {
    max-height: 100%;
    max-width: 100%;
    border-radius: 8px;
    object-fit: contain;
}

.response-area {
    flex: 1;
}

/* 3. CARDS & GRID */
.response-grid {
    display: grid;
    gap: 1rem;
    grid-template-columns: 1fr 1fr; 
}

.card {
    position: relative;
    border: 2px solid #eee;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 12px;
    cursor: pointer;
    background: #fff;
    text-align: center;
    font-weight: bold;
    transition: transform 0.1s, border-color 0.2s;
}

.card:active { transform: scale(0.98); }
.card.correct { border-color: #28a745; background: #f0fff4; }
.card.incorrect { border-color: var(--geo-red); background: #fff5f5; }

.card-img-wrapper {
    height: 50px;
    width: 100%;
    display: flex;
    justify-content: center;
    margin-bottom: 5px;
}
.card-img-wrapper img { height: 100%; object-fit: contain; }

.hotkey-label {
    position: absolute;
    top: 5px;
    left: 8px;
    font-size: 0.7rem;
    color: #ccc;
}

/* 4. BUTTONS & INPUTS */
.btn {
    padding: 14px 24px;
    border: none;
    border-radius: 10px;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    transition: background 0.2s;
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary { background: var(--geo-dark); color: white; }
.btn-outline { background: #fff; color: #444; border: 2px solid #ddd; }
.btn-recording { background: #dc3545 !important; color: white !important; animation: simple-pulse 1s infinite; }

.btn:disabled { background: #ccc; cursor: not-allowed; }

.btn-next-active {
    background: var(--geo-red) !important; 
    color: white !important;
    animation: pulse-red 2s infinite; /* Renamed to pulse-red */
}

input[type="text"] {
    width: 100%;
    padding: 16px;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 1.2rem;
    text-align: center;
    outline: none;
}
input[type="text"]:focus { border-color: var(--geo-red); }

/* 5. ANIMATIONS */
@keyframes pulse-red {
    0% { 
        box-shadow: 0 0 0 0 color-mix(in srgb, var(--geo-red), transparent 30%); 
    }
    70% { 
        box-shadow: 0 0 0 12px color-mix(in srgb, var(--geo-red), transparent 100%); 
    }
    100% { 
        box-shadow: 0 0 0 0 color-mix(in srgb, var(--geo-red), transparent 100%); 
    }
}

@keyframes simple-pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.7; }
}

.feedback-area {
    min-height: 45px;
    text-align: center;
    margin-bottom: 15px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
}

    </style>
</head>
<body>
    <header class="site-header">
        <div class="nav-container">
            <a href="index.html" class="brand">üá¨üá™ GeoDrills</a>

            <button class="menu-toggle" id="mobile-menu-btn" aria-label="Menu">
                <span></span><span></span><span></span>
            </button>

            <nav class="nav-links" id="nav-menu">
                
                <a href="Sounds.html" class="nav-link ">
                    Sounds
                </a>
                
                <a href="Verbs.html" class="nav-link ">
                    Verbs
                </a>
                
                <a href="Nouns.html" class="nav-link ">
                    Nouns
                </a>
                
                <a href="Pronouns.html" class="nav-link ">
                    Pronouns
                </a>
                
                <a href="Adjectives.html" class="nav-link ">
                    Adjectives
                </a>
                
            </nav>
        </div>
    </header>

    <div class="container">
        
<div id="app" v-cloak>
    
    <div v-if="!currentCard" class="content-section" style="text-align:center; justify-content:center;">
        <p v-if="!errorMessage">Loading first question...</p>
        <p v-else style="color: var(--geo-red)">{{ errorMessage }}</p>
    </div>

    <div v-else class="content-section">
        <div class="prompt-area">
            <div v-if="currentCard.prompt.image || currentCard.prompt.audio" class="media-placeholder">
                <img v-if="currentCard.prompt.image" :src="currentCard.prompt.image" class="question-img">
                <button v-else-if="currentCard.prompt.audio" class="btn btn-outline" @click="handleAudioAutoplay" style="width:auto;">
                    üîä Replay Sound
                </button>
                <audio ref="audioPromptRef" :src="currentCard.prompt.audio" hidden></audio>
            </div>
            <h2 style="margin: 0; font-size: 1.3rem; white-space: pre-line;">{{ currentCard.prompt.text }}</h2>
            <p v-if="currentCard.prompt.subtext" style="color: #666; margin: 8px 0 0 0;">{{ currentCard.prompt.subtext }}</p>
        </div>

        <div class="response-area">
            <div class="feedback-area">
                <span v-if="feedback.msg" :style="{ color: feedback.type === 'success' ? '#28a745' : 'var(--geo-red)' }">
                    {{ feedback.msg }}
                </span>
            </div>

            <div v-if="currentCard.response?.choices" class="response-grid">
                <div v-for="(choice, i) in currentCard.response.choices" 
                    :key="i" class="card"
                    :class="{ correct: selectedIndex === i && choice.isCorrect, incorrect: selectedIndex === i && !choice.isCorrect }"
                    @click="selectCard(i, choice.isCorrect)">
                    <span class="hotkey-label">{{ i + 1 }}</span>
                    <div class="card-img-wrapper" v-if="choice.image"><img :src="choice.image"></div>
                    <div>{{ choice.text }}</div>
                </div>
            </div>

            <div v-if="currentCard.response?.textAnswer !== undefined && !currentCard.response?.choices" class="input-stack" style="display:flex; flex-direction:column; gap:12px;">
                <input type="text" ref="textInputRef" v-model="textInput" placeholder="Type answer..." 
                       @keyup.enter="checkText" @blur="checkText">
                <button class="btn btn-primary" @click="checkText">Check Answer</button>
            </div>

            <div v-if="currentCard.response?.audioAnswer" class="input-stack" style="display:flex; flex-direction:column; gap:12px;">
                <div style="display:flex; gap:8px;">
                    <button v-if="!recordedUrl || isRecording" class="btn btn-outline" :class="{ 'btn-recording': isRecording }" @click="handleRecordClick">
                        {{ isRecording ? 'Stop' : 'üé§ Record' }}
                    </button>
                    <button v-else class="btn btn-outline" @click="toggleUserPlayback">
                        {{ userAudioPlaying ? '‚è∏ Pause' : '‚ñ∂Ô∏è Your Audio' }}
                    </button>
                </div>
                <button class="btn btn-primary" :disabled="!recordedUrl || isRecording" @click="toggleCorrectPlayback">
                    {{ correctAudioPlaying ? '‚è∏ Pause' : 'üîä Listen to Correct' }}
                </button>
                <audio ref="userAudioRef" :src="recordedUrl" hidden></audio>
                <audio ref="correctAudioRef" :src="currentCard.response.audioAnswer" hidden></audio>
            </div>
        </div>

        <div class="footer-section" style="margin-top:auto; padding: 20px 0;">
            <button class="btn btn-primary" 
                    :class="{ 'btn-next-active': feedback.type === 'success' && nextCard }" 
                    @click="advanceToNext" 
                    :disabled="!nextCard">
                {{ nextCard ? 'Next Question (Enter)' : 'Loading...' }}
            </button>
        </div>
    </div>
    
</div>

    </div>

    <script>
        // Simple Vanilla JS for the Hamburger Toggle
        const menuBtn = document.getElementById('mobile-menu-btn');
        const navMenu = document.getElementById('nav-menu');

        menuBtn.addEventListener('click', () => {
            navMenu.classList.toggle('is-open');
        });

        // Close menu if clicking a link (useful for SPAs, but good practice here)
        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', () => navMenu.classList.remove('is-open'));
        });
    </script>
    
<script>
    const API_BASE = "https://script.google.com/macros/s/AKfycby8ysnyr83c-vYmQ9QZtz6z1Til2BwlICE2O0nL8KrVjEYIwO3zZ4P0H2hHELeW6uSbQQ/exec";
    const { createApp, ref, nextTick, onMounted } = Vue;

    createApp({
        setup() {
            const currentCard = ref(null);
            const nextCard = ref(null);
            const errorMessage = ref('');
            const drillId = new URLSearchParams(window.location.search).get('drill');
            const selectedIndex = ref(null);
            const textInput = ref('');
            const textInputRef = ref(null);
            const feedback = ref({msg: '', type: ''});
            const recordedUrl = ref(null);
            const isRecording = ref(false);
            const userAudioPlaying = ref(false);
            const correctAudioPlaying = ref(false);
            const userAudioRef = ref(null);
            const correctAudioRef = ref(null);
            const audioPromptRef = ref(null);
            let mediaRecorder = null;
            let chunks = [];

            const fetchQuestion = async () => {
                if (!drillId) return null;
                try {
                    const response = await fetch(`${API_BASE}?drill=${drillId}`);
                    const json = await response.json();
                    return json.status === "ok" ? json.data : null;
                } catch (e) { return null; }
            };

            const loadInitialData = async () => {
                if (!drillId) {
                    errorMessage.value = "No Drill ID provided in URL.";
                    return;
                }
                const [first, second] = await Promise.all([fetchQuestion(), fetchQuestion()]);
                if (first) {
                    currentCard.value = first;
                    nextCard.value = second;
                    handleAudioAutoplay();
                    if (textInputRef.value) nextTick(() => textInputRef.value.focus());
                } else {
                    errorMessage.value = "Failed to load data from API.";
                }
            };

            const advanceToNext = async () => {
                if (!nextCard.value) return;
                currentCard.value = nextCard.value;
                nextCard.value = null;
                selectedIndex.value = null;
                textInput.value = '';
                feedback.value = {msg: '', type: ''};
                recordedUrl.value = null;
                fetchQuestion().then(data => { nextCard.value = data; });
                await nextTick();
                handleAudioAutoplay();
                if (textInputRef.value) textInputRef.value.focus();
            };

            const handleAudioAutoplay = async () => {
                if (currentCard.value?.prompt?.audio) {
                    await nextTick();
                    if (audioPromptRef.value) {
                        audioPromptRef.value.load();
                        audioPromptRef.value.play().catch(() => {});
                    }
                }
            };

            const selectCard = (idx, isCorrect) => {
                // Hotkeys always work now - user can change answer 
                selectedIndex.value = idx;
                feedback.value = isCorrect ? 
                    {msg: '‚úÖ Correct!', type: 'success'} : 
                    {msg: '‚ùå Try again.', type: 'error'};
            };

            const checkText = () => {
                if (!textInput.value.trim() && !feedback.value.msg) return;
                const answer = currentCard.value?.response?.textAnswer || '';
                const isCorrect = textInput.value.toLowerCase().trim() === answer.toLowerCase().trim();
                feedback.value = isCorrect ?
                    {msg: '‚úÖ Correct!', type: 'success'} : 
                    {msg: `‚ùå Expected: ${answer}`, type: 'error'};
            };

            const handleRecordClick = async () => {
                if (isRecording.value) {
                    mediaRecorder.stop();
                    isRecording.value = false;
                } else {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({audio: true});
                        mediaRecorder = new MediaRecorder(stream);
                        chunks = [];
                        mediaRecorder.ondataavailable = e => chunks.push(e.data);
                        mediaRecorder.onstop = async () => {
                            recordedUrl.value = URL.createObjectURL(new Blob(chunks));
                            await nextTick();
                            userAudioRef.value.load();
                            stream.getTracks().forEach(t => t.stop());
                        };
                        mediaRecorder.start();
                        isRecording.value = true;
                    } catch (err) {
                        feedback.value = {msg: "Microphone access denied.", type: "error"};
                    }
                }
            };

            const toggleUserPlayback = () => {
                const a = userAudioRef.value;
                userAudioPlaying.value ? a.pause() : a.play();
                userAudioPlaying.value = !userAudioPlaying.value;
                a.onended = () => userAudioPlaying.value = false;
            };

            const toggleCorrectPlayback = () => {
                const a = correctAudioRef.value;
                correctAudioPlaying.value ? a.pause() : a.play();
                correctAudioPlaying.value = !correctAudioPlaying.value;
                if (!feedback.value.msg) feedback.value = {msg: 'Listen and compare!', type: 'success'};
                a.onended = () => correctAudioPlaying.value = false;
            };

            onMounted(() => {
                loadInitialData();
                window.addEventListener('keydown', (e) => {
                    if (currentCard.value?.response?.choices) {
                        const num = parseInt(e.key);
                        if (!isNaN(num) && num >= 1 && num <= currentCard.value.response.choices.length) {
                            selectCard(num - 1, currentCard.value.response.choices[num - 1].isCorrect);
                        }
                    }
                    if (e.key === 'Enter') {
                        if (feedback.value.type === 'success' && nextCard.value) advanceToNext();
                        else if (currentCard.value?.response?.textAnswer !== undefined) checkText();
                    }
                    if (e.code === 'Space' && document.activeElement.tagName !== 'INPUT') {
                        e.preventDefault();
                        handleAudioAutoplay();
                    }
                });
            });

            return {
                currentCard, nextCard, errorMessage, selectedIndex, textInput, textInputRef, feedback,
                recordedUrl, isRecording, userAudioPlaying, correctAudioPlaying, 
                userAudioRef, correctAudioRef, audioPromptRef,
                advanceToNext, selectCard, checkText, handleRecordClick,
                toggleUserPlayback, toggleCorrectPlayback, handleAudioAutoplay
            };
        }
    }).mount('#app');
</script>

</body>
</html>